{% extends 'base.html' %}

{% block title %}Fact-Check Reports - SIRMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Compact Statistics -->
    <div class="grid grid-cols-3 gap-3 mb-3">
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-center">
            <div class="text-lg font-bold text-yellow-600">{{ total_pending }}</div>
            <div class="text-xs text-yellow-800">Pending</div>
        </div>
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-2 text-center">
            <div class="text-lg font-bold text-blue-600">{{ today_reports }}</div>
            <div class="text-xs text-blue-800">Today</div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-lg p-2 text-center">
            <div class="text-lg font-bold text-red-600">{{ urgent_reports }}</div>
            <div class="text-xs text-red-800">Urgent</div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border">
        <div class="p-3 border-b flex justify-between items-center">
            <h2 class="text-lg font-bold text-gray-900">Pending Reports for Verification</h2>
            <div class="flex space-x-2">
                <select id="priority-filter" class="px-2 py-1 border border-gray-300 rounded text-xs"
                    onchange="filterReports()">
                    <option value="">All Priority</option>
                    <option value="major">Major</option>
                    <option value="minor">Minor</option>
                </select>
                <select id="date-filter" class="px-2 py-1 border border-gray-300 rounded text-xs"
                    onchange="filterReports()">
                    <option value="">All Dates</option>
                    <option value="today">Today</option>
                    <option value="yesterday">Yesterday</option>
                    <option value="week">This Week</option>
                </select>
            </div>
        </div>

        {% if reports_with_students %}
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Report</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Student</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Incident</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Type</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Reporter</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Date/Time</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for item in reports_with_students %}
                    {% with report=item.report %}
                    <tr class="hover:bg-gray-50 report-item"
                        data-priority="{% if report.incident_type.severity %}{{ report.incident_type.severity }}{% else %}minor{% endif %}"
                        data-date="{{ report.created_at|date:'Y-m-d' }}">
                        <td class="px-3 py-2">
                            <div class="text-sm font-bold text-gray-900">{{ report.case_id }}</div>
                            <div class="text-xs text-gray-500">G{{ report.grade_level }} - {{ report.section_name }}</div>
                        </td>
                        <td class="px-3 py-2">
                            {% if item.involved_student_name %}
                            <div class="text-sm font-medium text-gray-900">{{ item.involved_student_name }}</div>
                            {% elif report.involved_students %}
                            <div class="text-xs text-gray-500">{{ report.involved_students|truncatewords:3 }}</div>
                            {% else %}
                            <div class="text-xs text-gray-400">Not specified</div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2">
                            {% if report.incident_type %}
                            <div class="text-sm text-gray-900">{{ report.incident_type.name|truncatewords:3 }}</div>
                            {% else %}
                            <div class="text-xs text-gray-400">Not specified</div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2">
                            {% if report.incident_type %}
                                {% if report.incident_type.severity == 'prohibited' %}
                                <span class="text-xs px-1.5 py-0.5 bg-red-100 text-red-800 rounded font-semibold">PA</span>
                                {% elif report.incident_type.severity == 'school_policy' %}
                                <span class="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded font-semibold">OSP</span>
                                {% endif %}
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-sm text-gray-900">{{ report.reporter.get_full_name|truncatewords:2 }}</div>
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-sm text-gray-900">{{ report.incident_date|date:"M d" }}</div>
                            <div class="text-xs text-gray-500">{{ report.incident_time|time:"g:i A" }}</div>
                        </td>
                        <td class="px-3 py-2">
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">
                                Pending
                            </span>
                            {% if report.evidence %}
                            <div class="text-xs text-blue-600 mt-1">üìé Evidence</div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2">
                            <div class="flex space-x-1">
                                <a href="{% url 'report_detail' report.case_id %}"
                                    class="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button
                                    class="inline-flex items-center px-2 py-1 text-xs font-medium text-white bg-green-600 rounded hover:bg-green-700"
                                    onclick="showClassifyModal('{{ report.id }}', '{{ report.case_id }}', {% if item.involved_student_id %}'{{ item.involved_student_id }}', '{{ item.involved_student_name|escapejs }}'{% else %}null, null{% endif %}, {% if item.raw_student_name %}'{{ item.raw_student_name|escapejs }}'{% else %}null{% endif %})">
                                    <i class="fas fa-check"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% else %}
        <div class="text-center py-8">
            <div class="text-4xl mb-2">‚úÖ</div>
            <div class="text-gray-500 text-sm">No reports pending fact-check</div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Classification Modal -->
<div id="classifyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-10 mx-auto p-4 border w-full max-w-2xl shadow-2xl rounded-xl bg-white max-h-[90vh] overflow-y-auto">
        <div>
            <div class="flex justify-between items-center mb-3 pb-2 border-b">
                <h3 class="text-base font-bold text-gray-900 flex items-center">
                    <i class="fas fa-clipboard-check text-emerald-600 mr-2"></i>
                    Verify & Classify Report
                </h3>
                <button onclick="hideClassifyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form method="post" id="classifyForm">
                {% csrf_token %}
                <input type="hidden" name="report_id" id="modalReportId">
                <input type="hidden" name="action" value="verify">

                <!-- Evidence Status Section -->
                <div class="mb-3 p-2 bg-blue-50 border-l-4 border-blue-500 rounded">
                    <label class="block text-xs font-bold text-gray-800 mb-1">
                        Evidence Status <span class="text-red-500">*</span>
                    </label>
                    <div class="space-y-1">
                        <label class="flex items-center p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                            <input type="radio" name="evidence_status" value="clear" class="mr-2 w-3 h-3" checked required>
                            <div class="text-xs">
                                <span class="font-semibold text-emerald-700">‚úÖ Clear</span>
                                <span class="text-gray-600"> - Sufficient evidence</span>
                            </div>
                        </label>
                        <label class="flex items-center p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                            <input type="radio" name="evidence_status" value="insufficient" class="mr-2 w-3 h-3" required>
                            <div class="text-xs">
                                <span class="font-semibold text-orange-700">‚ö†Ô∏è Insufficient</span>
                                <span class="text-gray-600"> - Need more evidence</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Evidence Notes (shown when insufficient) -->
                <div class="mb-3" id="evidenceNotesSection" style="display: none;">
                    <label class="block text-xs font-bold text-gray-800 mb-1">
                        Reason <span class="text-red-500">*</span>
                    </label>
                    <textarea name="evidence_notes" id="evidenceNotesField" rows="2"
                        class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-orange-500 outline-none"
                        placeholder="What additional evidence is needed?"></textarea>
                </div>

                <!-- Classification Section (shown when evidence is clear) -->
                <div id="classificationSection">
                    <!-- Student Assignment -->
                    <div class="mb-3 p-2 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                        <label class="block text-xs font-bold text-gray-800 mb-1">
                            Student Involved <span class="text-red-500">*</span>
                        </label>
                        
                        <!-- Show assigned student -->
                        <div id="assignedStudentDisplay" style="display: none;">
                            <div class="flex items-center justify-between p-2 bg-green-50 border border-green-200 rounded">
                                <div>
                                    <div class="text-sm font-semibold text-green-800" id="assignedStudentName"></div>
                                    <div class="text-xs text-green-600">Already assigned</div>
                                </div>
                                <button type="button" onclick="changeStudent()" class="text-xs text-blue-600 hover:underline">
                                    Change
                                </button>
                            </div>
                            <input type="hidden" name="student_id" id="assignedStudentId">
                        </div>
                        
                        <!-- Show search box -->
                        <div id="studentSearchBox">
                            <input type="text" id="studentSearch" list="studentList" 
                                class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-yellow-500 outline-none"
                                placeholder="Search student name or email..."
                                onchange="updateStudentId(this.value)">
                            <input type="hidden" name="student_id" id="selectedStudentId">
                            <datalist id="studentList">
                                {% for student in students %}
                                <option value="{{ student.get_full_name }} ({{ student.email }})" data-id="{{ student.id }}" data-name="{{ student.get_full_name }}">
                                {% endfor %}
                            </datalist>
                        </div>
                    </div>
                    
                    <div class="mb-3 p-2 bg-emerald-50 border-l-4 border-emerald-500 rounded">
                        <label class="block text-xs font-bold text-gray-800 mb-1">
                            Case Routing <span class="text-red-500">*</span>
                        </label>
                        <div class="space-y-1">
                            <label class="flex items-start p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                                <input type="radio" name="severity" value="minor" id="severityField" class="mr-2 mt-0.5 w-3 h-3" required>
                                <div class="text-xs">
                                    <div class="font-semibold text-blue-700">üè¢ Discipline Office</div>
                                    <div class="text-gray-600">Minor violations - DO handles</div>
                                </div>
                            </label>
                            <label class="flex items-start p-1.5 border border-gray-200 rounded hover:bg-white cursor-pointer">
                                <input type="radio" name="severity" value="major" class="mr-2 mt-0.5 w-3 h-3" required>
                                <div class="text-xs">
                                    <div class="font-semibold text-purple-700">üß† Guidance Counselor</div>
                                    <div class="text-gray-600">Major violations - Counseling needed</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="block text-xs font-bold text-gray-800 mb-1">
                            Notes (Optional)
                        </label>
                        <textarea name="notes" rows="2"
                            class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:border-emerald-500 outline-none"
                            placeholder="Routing decision notes..."></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-2 pt-2 border-t">
                    <button type="button"
                        class="bg-gray-500 text-white px-3 py-1.5 rounded hover:bg-gray-600 text-xs font-semibold"
                        onclick="hideClassifyModal()">
                        Cancel
                    </button>
                    <button type="submit" id="submitBtn"
                        class="bg-emerald-600 text-white px-3 py-1.5 rounded hover:bg-emerald-700 text-xs font-semibold">
                        <i class="fas fa-check mr-1"></i> Verify & Classify
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function filterReports() {
        const priorityFilter = document.getElementById('priority-filter').value;
        const dateFilter = document.getElementById('date-filter').value;
        const reportItems = document.querySelectorAll('.report-item');

        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate() - 7);

        reportItems.forEach(item => {
            const itemPriority = item.getAttribute('data-priority');
            const itemDateStr = item.getAttribute('data-date');
            const itemDate = new Date(itemDateStr);

            let showItem = true;

            // Priority filter
            if (priorityFilter && itemPriority !== priorityFilter) {
                showItem = false;
            }

            // Date filter
            if (dateFilter) {
                if (dateFilter === 'today' && itemDate.toDateString() !== today.toDateString()) {
                    showItem = false;
                } else if (dateFilter === 'yesterday' && itemDate.toDateString() !== yesterday.toDateString()) {
                    showItem = false;
                } else if (dateFilter === 'week' && itemDate < weekAgo) {
                    showItem = false;
                }
            }

            item.style.display = showItem ? 'block' : 'none';
        });
    }

    // Classification Modal Functions
    function showClassifyModal(reportId, caseId, studentId, studentName, rawStudentName) {
        document.getElementById('modalReportId').value = reportId;
        document.querySelector('#classifyModal h3 i').nextSibling.textContent = ` Verify & Classify Report - Case ${caseId}`;
        
        // Handle student display
        const assignedDisplay = document.getElementById('assignedStudentDisplay');
        const searchBox = document.getElementById('studentSearchBox');
        const studentSearch = document.getElementById('studentSearch');
        const selectedStudentId = document.getElementById('selectedStudentId');
        
        if (studentId && studentName) {
            // Student found from involved_students or involved_parties - auto-fill search field
            // Find the option in datalist that matches this student
            const datalist = document.getElementById('studentList');
            const options = datalist.querySelectorAll('option');
            let foundOption = null;
            
            for (let option of options) {
                const optionId = option.getAttribute('data-id');
                if (optionId === studentId) {
                    foundOption = option.value;
                    break;
                }
            }
            
            if (foundOption) {
                // Auto-fill the search field with the student name
                studentSearch.value = foundOption;
                selectedStudentId.value = studentId;
                // Show search box (not assigned display) so user can see and modify if needed
                assignedDisplay.style.display = 'none';
                searchBox.style.display = 'block';
            } else {
                // If not found in datalist, show as assigned
                document.getElementById('assignedStudentName').textContent = studentName;
                document.getElementById('assignedStudentId').value = studentId;
                assignedDisplay.style.display = 'block';
                searchBox.style.display = 'none';
            }
        } else if (rawStudentName) {
            // No matching student found, but we have a raw name from involved_students field
            // Display the name in the search field so DO can see it and search for the student
            studentSearch.value = rawStudentName;
            selectedStudentId.value = '';
            assignedDisplay.style.display = 'none';
            searchBox.style.display = 'block';
            // Focus on the search field to help user find the student
            setTimeout(() => {
                studentSearch.focus();
                // Try to trigger autocomplete/datalist
                studentSearch.dispatchEvent(new Event('input', { bubbles: true }));
            }, 100);
        } else {
            // No student - show search, hide assigned
            assignedDisplay.style.display = 'none';
            searchBox.style.display = 'block';
            studentSearch.value = '';
            selectedStudentId.value = '';
        }
        
        document.getElementById('classifyModal').classList.remove('hidden');
    }
    
    function changeStudent() {
        // Switch from assigned display to search box
        document.getElementById('assignedStudentDisplay').style.display = 'none';
        document.getElementById('studentSearchBox').style.display = 'block';
        document.getElementById('studentSearch').value = '';
        document.getElementById('selectedStudentId').value = '';
        document.getElementById('studentSearch').focus();
    }

    function hideClassifyModal() {
        document.getElementById('classifyModal').classList.add('hidden');
        document.getElementById('classifyForm').reset();
        // Reset visibility
        document.getElementById('classificationSection').style.display = 'block';
        document.getElementById('evidenceNotesSection').style.display = 'none';
        document.getElementById('severityField').required = true;
        document.getElementById('evidenceNotesField').required = false;
    }

    // Close modal when clicking outside
    document.getElementById('classifyModal').addEventListener('click', function (e) {
        if (e.target === this) {
            hideClassifyModal();
        }
    });

    // Handle evidence status radio button changes
    document.addEventListener('DOMContentLoaded', function () {
        const evidenceRadios = document.querySelectorAll('input[name="evidence_status"]');
        const classificationSection = document.getElementById('classificationSection');
        const evidenceNotesSection = document.getElementById('evidenceNotesSection');
        const severityField = document.getElementById('severityField');
        const evidenceNotesField = document.getElementById('evidenceNotesField');
        const submitBtn = document.getElementById('submitBtn');

        evidenceRadios.forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.value === 'insufficient') {
                    // Show evidence notes, hide classification
                    classificationSection.style.display = 'none';
                    evidenceNotesSection.style.display = 'block';
                    severityField.required = false;
                    evidenceNotesField.required = true;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-1"></i> Request More Evidence';
                    submitBtn.className = 'bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700 transition-colors text-sm font-semibold';
                } else {
                    // Show classification, hide evidence notes
                    classificationSection.style.display = 'block';
                    evidenceNotesSection.style.display = 'none';
                    severityField.required = true;
                    evidenceNotesField.required = false;
                    submitBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Verify & Classify';
                    submitBtn.className = 'bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors text-sm font-semibold';
                }
            });
        });

        // Highlight new reports
        const newItems = document.querySelectorAll('.report-item:has(.bg-blue-100)');
        newItems.forEach(item => {
            item.style.animation = 'pulse 2s infinite';
        });
    });

    // Auto-refresh every 2 minutes to check for new reports
    setInterval(function () {
        // Uncomment the line below if you want auto-refresh
        // location.reload();
    }, 120000);
    
    // Student search and selection
    function updateStudentId(selectedValue) {
        const datalist = document.getElementById('studentList');
        const options = datalist.querySelectorAll('option');
        const hiddenInput = document.getElementById('selectedStudentId');
        
        // Find matching option and get its data-id
        for (let option of options) {
            if (option.value === selectedValue) {
                hiddenInput.value = option.getAttribute('data-id');
                return;
            }
        }
        
        // Also try partial match by name (in case format is slightly different)
        if (selectedValue) {
            for (let option of options) {
                const optionName = option.getAttribute('data-name');
                if (optionName && selectedValue.includes(optionName)) {
                    hiddenInput.value = option.getAttribute('data-id');
                    return;
                }
            }
        }
        
        // If no match, clear the hidden input
        hiddenInput.value = '';
    }
    
    // Alternative: Enhanced search with live filtering
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('studentSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                // The datalist will automatically filter options as user types
                // This is native HTML5 functionality
            });
        }
    });
</script>

<style>
    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
    }
</style>

{% endblock %}