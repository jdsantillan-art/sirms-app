{% extends 'base.html' %}

{% block title %}Dashboard - SIRMS{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
    .chart-container {
        position: relative;
        height: 200px;
        width: 100%;
        min-height: 200px;
    }

    .chart-container canvas {
        display: block;
        width: 100% !important;
        height: 100% !important;
    }

    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card-shadow {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    /* Ultra compact dashboard */
    .dashboard-compact {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
    }

    .analytics-card-compact {
        padding: 0.5rem !important;
        border-radius: 0.5rem !important;
    }

    .analytics-card-compact p:first-child {
        font-size: 0.75rem !important;
        margin-bottom: 0.25rem !important;
    }

    .analytics-card-compact .counter {
        font-size: 1.5rem !important;
        line-height: 1.2 !important;
    }

    .analytics-card-compact p:last-child {
        font-size: 0.65rem !important;
        margin-top: 0.25rem !important;
    }

    .analytics-card-compact i {
        font-size: 1.125rem !important;
    }

    .chart-card-compact {
        padding: 0.75rem !important;
    }

    .chart-card-compact h3 {
        font-size: 0.875rem !important;
        margin-bottom: 0.5rem !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-2 sm:px-3 lg:px-4 dashboard-compact">
    {% if user.role == 'student' or user.role == 'teacher' %}
    <!-- Educational Dashboard -->
    <div class="space-y-6">
        <!-- How to Report an Incident -->
        <div class="bg-white rounded-2xl p-8 card-shadow fade-in">
            <div class="flex items-center mb-6">
                <div class="bg-gradient-to-br from-emerald-600 to-teal-600 p-3 rounded-xl mr-4">
                    <i class="fas fa-clipboard-list text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">How to Report an Incident</h2>
                    <p class="text-gray-600">Follow these simple steps to submit a confidential report</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div
                    class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-5 text-center border-t-4 border-blue-500 hover:shadow-lg transition-all">
                    <div
                        class="bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-3 text-lg font-bold shadow-md">
                        1</div>
                    <h4 class="font-bold text-blue-900 mb-2">Click Report</h4>
                    <p class="text-sm text-blue-700">Navigate to "Report Incident" in the sidebar</p>
                </div>
                <div
                    class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 text-center border-t-4 border-green-500 hover:shadow-lg transition-all">
                    <div
                        class="bg-green-500 text-white rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-3 text-lg font-bold shadow-md">
                        2</div>
                    <h4 class="font-bold text-green-900 mb-2">Fill Details</h4>
                    <p class="text-sm text-green-700">Complete all required information accurately</p>
                </div>
                <div
                    class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-5 text-center border-t-4 border-purple-500 hover:shadow-lg transition-all">
                    <div
                        class="bg-purple-500 text-white rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-3 text-lg font-bold shadow-md">
                        3</div>
                    <h4 class="font-bold text-purple-900 mb-2">Attach Evidence</h4>
                    <p class="text-sm text-purple-700">Upload photos, videos, or documents</p>
                </div>
                <div
                    class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-5 text-center border-t-4 border-orange-500 hover:shadow-lg transition-all">
                    <div
                        class="bg-orange-500 text-white rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-3 text-lg font-bold shadow-md">
                        4</div>
                    <h4 class="font-bold text-orange-900 mb-2">Submit Report</h4>
                    <p class="text-sm text-orange-700">Review and submit your report</p>
                </div>
                <div
                    class="bg-gradient-to-br from-red-50 to-red-100 rounded-xl p-5 text-center border-t-4 border-red-500 hover:shadow-lg transition-all">
                    <div
                        class="bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center mx-auto mb-3 text-lg font-bold shadow-md">
                        5</div>
                    <h4 class="font-bold text-red-900 mb-2">Track Status</h4>
                    <p class="text-sm text-red-700">Monitor your case progress</p>
                </div>
            </div>
        </div>

        <!-- Know Your Rights & School Policies -->
        <div class="bg-white rounded-2xl p-8 card-shadow fade-in">
            <div class="flex items-center mb-6">
                <div class="bg-gradient-to-br from-indigo-600 to-purple-600 p-3 rounded-xl mr-4">
                    <i class="fas fa-balance-scale text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Know Your Rights & School Policies</h2>
                    <p class="text-gray-600">Understanding your rights and responsibilities</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Anti-Bullying Policy -->
                <div class="bg-gradient-to-br from-rose-50 to-pink-50 rounded-xl p-6 border-l-4 border-rose-500">
                    <div class="flex items-center mb-4">
                        <div class="bg-rose-100 p-2 rounded-lg mr-3">
                            <i class="fas fa-shield-alt text-rose-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-rose-900">Anti-Bullying Policy</h3>
                    </div>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-rose-500 mt-1 mr-2"></i>
                            <span>Zero tolerance for physical, verbal, or cyber bullying</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-rose-500 mt-1 mr-2"></i>
                            <span>Right to report incidents confidentially</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-rose-500 mt-1 mr-2"></i>
                            <span>Protection from retaliation</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-rose-500 mt-1 mr-2"></i>
                            <span>Immediate investigation of all reports</span>
                        </li>
                    </ul>
                    <a href="{% url 'legal_references' %}"
                        class="mt-4 inline-flex items-center text-rose-600 hover:text-rose-700 font-semibold text-sm">
                        <span>Read Full Policy</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>

                <!-- Child Protection -->
                <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-6 border-l-4 border-blue-500">
                    <div class="flex items-center mb-4">
                        <div class="bg-blue-100 p-2 rounded-lg mr-3">
                            <i class="fas fa-child text-blue-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-blue-900">Child Protection</h3>
                    </div>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                            <span>Safe and supportive learning environment</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                            <span>Compliance with DepEd Child Protection Policy</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                            <span>Mandatory reporting of abuse or neglect</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-blue-500 mt-1 mr-2"></i>
                            <span>Counseling and support services available</span>
                        </li>
                    </ul>
                    <a href="{% url 'legal_references' %}"
                        class="mt-4 inline-flex items-center text-blue-600 hover:text-blue-700 font-semibold text-sm">
                        <span>Learn More</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>

                <!-- Discipline Guidelines -->
                <div class="bg-gradient-to-br from-amber-50 to-yellow-50 rounded-xl p-6 border-l-4 border-amber-500">
                    <div class="flex items-center mb-4">
                        <div class="bg-amber-100 p-2 rounded-lg mr-3">
                            <i class="fas fa-gavel text-amber-600 text-xl"></i>
                        </div>
                        <h3 class="text-lg font-bold text-amber-900">Discipline Guidelines</h3>
                    </div>
                    <ul class="space-y-2 text-sm text-gray-700">
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-amber-500 mt-1 mr-2"></i>
                            <span>Fair and transparent disciplinary process</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-amber-500 mt-1 mr-2"></i>
                            <span>Right to be heard and present evidence</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-amber-500 mt-1 mr-2"></i>
                            <span>Progressive discipline approach</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fas fa-check-circle text-amber-500 mt-1 mr-2"></i>
                            <span>Focus on rehabilitation and learning</span>
                        </li>
                    </ul>
                    <a href="{% url 'legal_references' %}"
                        class="mt-4 inline-flex items-center text-amber-600 hover:text-amber-700 font-semibold text-sm">
                        <span>View Guidelines</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- Guidance & Support Contacts -->
        <div class="bg-white rounded-2xl p-8 card-shadow fade-in">
            <div class="flex items-center mb-6">
                <div class="bg-gradient-to-br from-teal-600 to-cyan-600 p-3 rounded-xl mr-4">
                    <i class="fas fa-hands-helping text-white text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-gray-900">Guidance & Support Contacts</h2>
                    <p class="text-gray-600">We're here to help you - reach out anytime</p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Guidance Counselor -->
                <div
                    class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl p-6 border-t-4 border-emerald-500 hover:shadow-lg transition-all">
                    <div class="bg-emerald-100 w-12 h-12 rounded-full flex items-center justify-center mb-4 mx-auto">
                        <i class="fas fa-user-tie text-emerald-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-900 text-center mb-2">Guidance Counselor</h3>
                    <p class="text-sm text-gray-600 text-center mb-3">For emotional support and counseling</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-center text-emerald-700">
                            <i class="fas fa-envelope mr-2"></i>
                            <span>guidance@dmlmhs.edu.ph</span>
                        </div>
                        <div class="flex items-center justify-center text-emerald-700">
                            <i class="fas fa-phone mr-2"></i>
                            <span>(034) 495-0036 ext. 101</span>
                        </div>
                    </div>
                </div>

                <!-- Discipline Officer -->
                <div
                    class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-t-4 border-blue-500 hover:shadow-lg transition-all">
                    <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mb-4 mx-auto">
                        <i class="fas fa-clipboard-check text-blue-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-900 text-center mb-2">Discipline Officer</h3>
                    <p class="text-sm text-gray-600 text-center mb-3">For incident reports and violations</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-center text-blue-700">
                            <i class="fas fa-envelope mr-2"></i>
                            <span>discipline@dmlmhs.edu.ph</span>
                        </div>
                        <div class="flex items-center justify-center text-blue-700">
                            <i class="fas fa-phone mr-2"></i>
                            <span>(034) 495-0036 ext. 102</span>
                        </div>
                    </div>
                </div>

                <!-- Principal's Office -->
                <div
                    class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border-t-4 border-purple-500 hover:shadow-lg transition-all">
                    <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mb-4 mx-auto">
                        <i class="fas fa-user-graduate text-purple-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-900 text-center mb-2">Principal's Office</h3>
                    <p class="text-sm text-gray-600 text-center mb-3">For serious concerns and appeals</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-center text-purple-700">
                            <i class="fas fa-envelope mr-2"></i>
                            <span>principal@dmlmhs.edu.ph</span>
                        </div>
                        <div class="flex items-center justify-center text-purple-700">
                            <i class="fas fa-phone mr-2"></i>
                            <span>(034) 495-0036 ext. 100</span>
                        </div>
                    </div>
                </div>

                <!-- Emergency Hotline -->
                <div
                    class="bg-gradient-to-br from-red-50 to-orange-50 rounded-xl p-6 border-t-4 border-red-500 hover:shadow-lg transition-all">
                    <div class="bg-red-100 w-12 h-12 rounded-full flex items-center justify-center mb-4 mx-auto">
                        <i class="fas fa-phone-volume text-red-600 text-xl"></i>
                    </div>
                    <h3 class="font-bold text-gray-900 text-center mb-2">Emergency Hotline</h3>
                    <p class="text-sm text-gray-600 text-center mb-3">For urgent situations 24/7</p>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center justify-center text-red-700 font-bold">
                            <i class="fas fa-phone-alt mr-2"></i>
                            <span>911 or 117</span>
                        </div>
                        <div class="flex items-center justify-center text-red-700">
                            <i class="fas fa-mobile-alt mr-2"></i>
                            <span>0917-123-4567</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Resources -->
            <div class="mt-6 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-6 border-l-4 border-emerald-500">
                <div class="flex items-start">
                    <i class="fas fa-info-circle text-emerald-600 text-2xl mr-4 mt-1"></i>
                    <div>
                        <h4 class="font-bold text-gray-900 mb-2">Remember:</h4>
                        <p class="text-gray-700 text-sm leading-relaxed">
                            All reports are treated with strict confidentiality. You have the right to a safe learning
                            environment.
                            Don't hesitate to reach out - we're here to support you every step of the way. Your
                            well-being is our priority.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Analytics Dashboard -->
    <div class="mb-3">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-2">
                <select id="dateRange" class="border border-gray-300 rounded px-2 py-1 text-xs"
                    onchange="updateCharts()">
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <button onclick="toggleAutoRefresh()" id="autoRefreshBtn"
                    class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded text-xs">
                    Auto-Refresh: OFF
                </button>
            </div>
        </div>
    </div>

    <!-- Counter Cards -->
    {% if user.role == 'principal' %}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
        <a href="{% url 'all_reports' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-3 border-l-4 border-blue-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-medium">Total Reports</p>
                        <p class="text-2xl font-bold text-blue-700 counter" data-target="{{ total_reports|default:0 }}">
                            0</p>
                        <p class="text-xs text-blue-500 mt-1">Click to view all</p>
                    </div>
                    <i class="fas fa-chart-line text-blue-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'all_reports' %}?status=resolved" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-3 border-l-4 border-green-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 text-sm font-medium">Resolved Cases</p>
                        <p class="text-2xl font-bold text-green-700 counter"
                            data-target="{{ resolution_rate|default:0 }}">0</p>
                        <p class="text-xs text-green-500 mt-1">Click to view resolved</p>
                    </div>
                    <i class="fas fa-check-circle text-green-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'sanction_management' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-red-50 to-red-100 rounded-lg p-3 border-l-4 border-red-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-600 text-sm font-medium">Active Sanctions</p>
                        <p class="text-2xl font-bold text-red-700 counter"
                            data-target="{{ active_sanctions|default:0 }}">0</p>
                        <p class="text-xs text-red-500 mt-1">Click to manage</p>
                    </div>
                    <i class="fas fa-gavel text-red-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'counseling_schedule' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-3 border-l-4 border-orange-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-600 text-sm font-medium">Active Counseling</p>
                        <p class="text-2xl font-bold text-orange-700 counter"
                            data-target="{{ scheduled_sessions|default:0 }}">0</p>
                        <p class="text-xs text-orange-500 mt-1">Click to view sessions</p>
                    </div>
                    <i class="fas fa-comments text-orange-700 text-xl"></i>
                </div>
            </div>
        </a>
    </div>
    {% elif user.role == 'counselor' %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
        <a href="{% url 'prohibited_acts' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-red-50 to-red-100 rounded-lg p-3 border-l-4 border-red-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-red-600 text-sm font-medium">Total Prohibited Acts</p>
                        <p class="text-2xl font-bold text-red-700 counter"
                            data-target="{{ total_prohibited_acts|default:0 }}">{{ total_prohibited_acts|default:0 }}
                        </p>
                        <p class="text-xs text-red-500 mt-1">Click to view PA reports</p>
                    </div>
                    <i class="fas fa-ban text-red-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'other_school_policies' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-3 border-l-4 border-blue-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-medium">Total OSP</p>
                        <p class="text-2xl font-bold text-blue-700 counter" data-target="{{ total_osp|default:0 }}">0
                        </p>
                        <p class="text-xs text-blue-500 mt-1">Click to view OSP reports</p>
                    </div>
                    <i class="fas fa-clipboard-list text-blue-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'counselor_schedule' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-3 border-l-4 border-purple-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-600 text-sm font-medium">Scheduled Sessions</p>
                        <p class="text-2xl font-bold text-purple-700 counter"
                            data-target="{{ scheduled_sessions|default:0 }}">0</p>
                        <p class="text-xs text-purple-500 mt-1">Click to view schedule</p>
                    </div>
                    <i class="fas fa-calendar-alt text-purple-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'completed_sessions' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-3 border-l-4 border-green-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 text-sm font-medium">Completed Sessions</p>
                        <p class="text-2xl font-bold text-green-700 counter"
                            data-target="{{ completed_sessions|default:0 }}">0</p>
                        <p class="text-xs text-green-500 mt-1">Click to view completed</p>
                    </div>
                    <i class="fas fa-check-circle text-green-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'for_vpf' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-3 border-l-4 border-orange-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-orange-600 text-sm font-medium">Completed VPF</p>
                        <p class="text-2xl font-bold text-orange-700 counter"
                            data-target="{{ completed_vpf|default:0 }}">0</p>
                        <p class="text-xs text-orange-500 mt-1">Click to view VPF</p>
                    </div>
                    <i class="fas fa-user-shield text-orange-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'for_vpf' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-teal-50 to-teal-100 rounded-lg p-3 border-l-4 border-teal-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-teal-600 text-sm font-medium">Total VPF Referrals</p>
                        <p class="text-2xl font-bold text-teal-700 counter"
                            data-target="{{ total_vpf_referrals|default:0 }}">0</p>
                        <p class="text-xs text-teal-500 mt-1">Click to view all VPF</p>
                    </div>
                    <i class="fas fa-user-check text-teal-700 text-xl"></i>
                </div>
            </div>
        </a>
    </div>
    {% elif user.role == 'esp_teacher' %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-3">
        <a href="{% url 'vpf_schedule' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-3 border-l-4 border-purple-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-600 text-sm font-medium">Scheduled Sessions</p>
                        <p class="text-2xl font-bold text-purple-700 counter"
                            data-target="{{ scheduled_vpf_sessions|default:0 }}">0</p>
                        <p class="text-xs text-purple-500 mt-1">Click to manage VPF schedule</p>
                    </div>
                    <i class="fas fa-calendar-alt text-purple-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'vpf_cases' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-3 border-l-4 border-green-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-green-600 text-sm font-medium">Completed VPF</p>
                        <p class="text-2xl font-bold text-green-700 counter"
                            data-target="{{ completed_vpf|default:0 }}">0</p>
                        <p class="text-xs text-green-500 mt-1">Click to view completed</p>
                    </div>
                    <i class="fas fa-check-circle text-green-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'vpf_cases' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-3 border-l-4 border-blue-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-medium">Total VPF Referrals</p>
                        <p class="text-2xl font-bold text-blue-700 counter"
                            data-target="{{ total_vpf_referrals|default:0 }}">0</p>
                        <p class="text-xs text-blue-500 mt-1">Click to view all VPF</p>
                    </div>
                    <i class="fas fa-user-shield text-blue-700 text-xl"></i>
                </div>
            </div>
        </a>
    </div>
    {% elif user.role == 'do' %}
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 mb-3">
        <a href="{% url 'all_reports' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-indigo-50 to-indigo-100 rounded-lg p-3 border-l-4 border-indigo-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-indigo-600 text-sm font-medium">Total Reports</p>
                        <p class="text-2xl font-bold text-indigo-700 counter"
                            data-target="{{ total_reports|default:0 }}">{{ total_reports|default:0 }}</p>
                        <p class="text-xs text-indigo-500 mt-1">Click to view all</p>
                    </div>
                    <i class="fas fa-clipboard-list text-indigo-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'classify_violations' %}" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-yellow-50 to-yellow-100 rounded-lg p-3 border-l-4 border-yellow-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-yellow-600 text-sm font-medium">Pending</p>
                        <p class="text-2xl font-bold text-yellow-700 counter" data-target="{{ pending|default:0 }}">{{
                            pending|default:0 }}</p>
                        <p class="text-xs text-yellow-500 mt-1">Click to classify</p>
                    </div>
                    <i class="fas fa-clock text-yellow-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'all_reports' %}?severity=minor" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-3 border-l-4 border-blue-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-blue-600 text-sm font-medium">üè¢ Handled by DO</p>
                        <p class="text-2xl font-bold text-blue-700 counter"
                            data-target="{{ minor_cases_count|default:0 }}">{{ minor_cases_count|default:0 }}</p>
                        <p class="text-xs text-blue-500 mt-1">Cases managed by Discipline Office</p>
                    </div>
                    <i class="fas fa-building text-blue-700 text-xl"></i>
                </div>
            </div>
        </a>
        <a href="{% url 'all_reports' %}?severity=major" class="block hover:scale-105 transition-transform">
            <div
                class="bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg p-3 border-l-4 border-purple-500 cursor-pointer hover:shadow-md">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-600 text-sm font-medium">üß† Sent to Counselor</p>
                        <p class="text-2xl font-bold text-purple-700 counter"
                            data-target="{{ major_cases_count|default:0 }}">{{ major_cases_count|default:0 }}</p>
                        <p class="text-xs text-purple-500 mt-1">Cases referred for counseling</p>
                    </div>
                    <i class="fas fa-user-md text-purple-700 text-xl"></i>
                </div>
            </div>
        </a>
        {% endif %}
    </div>

    <!-- Charts -->
    {% if user.role == 'do' %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 mb-3">
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Violation Trend</h3>
            <div class="chart-container">
                <canvas id="doTrendChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Grade Reports</h3>
            <div class="chart-container">
                <canvas id="doGradeChart"></canvas>
            </div>
        </div>
        <div class="lg:col-span-2 bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Top Violations</h3>
            <div class="chart-container">
                <canvas id="doViolationChart"></canvas>
            </div>
        </div>
    </div>
    {% elif user.role == 'counselor' %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 mb-3">
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Counseling Trend</h3>
            <div class="chart-container">
                <canvas id="counselorTrendChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Grade Distribution</h3>
            <div class="chart-container">
                <canvas id="counselorGradeChart"></canvas>
            </div>
        </div>
        <div class="lg:col-span-2 bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Top Incident Types</h3>
            <div class="chart-container">
                <canvas id="counselorIncidentChart"></canvas>
            </div>
        </div>
    </div>
    {% elif user.role == 'esp_teacher' %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 mb-3">
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">VPF Status Distribution</h3>
            <div class="chart-container">
                <canvas id="espVpfStatusChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">VPF Improvement Rate</h3>
            <div class="chart-container">
                <canvas id="espImprovementChart"></canvas>
            </div>
        </div>
    </div>
    {% elif user.role == 'principal' %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-2 mb-3">
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Schoolwide Trend</h3>
            <div class="chart-container">
                <canvas id="principalTrendChart"></canvas>
            </div>
        </div>
        <div class="bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Case Distribution</h3>
            <div class="chart-container">
                <canvas id="principalDistributionChart"></canvas>
            </div>
        </div>
        <div class="lg:col-span-2 bg-white rounded-lg chart-card-compact card-shadow">
            <h3 class="text-sm font-semibold text-gray-800 mb-2">Grade Analysis</h3>
            <div class="chart-container">
                <canvas id="principalGradeChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}
</div>

{% load static %}
<script src="{% static 'js/chart.js' %}"></script>
<script>
    // Test if Chart.js loaded
    console.log('=== CHART.JS LOAD TEST ===');
    console.log('Chart object exists:', typeof Chart !== 'undefined');
    if (typeof Chart !== 'undefined') {
        console.log('Chart.js version:', Chart.version);
    } else {
        console.error('‚ùå Chart.js DID NOT LOAD!');
    }

    // Real data from backend
    let trendData, gradeData, violationTypeData, resolutionData;
    try {
        trendData = {{ trend_data | safe }
    } || [];
    gradeData = {{ grade_data | safe }} || [];
    violationTypeData = {{ violation_type_data | safe }} || [];
    resolutionData = {{ resolution_data | safe }} || [];
    } catch (e) {
        trendData = [];
        gradeData = [];
        violationTypeData = [];
        resolutionData = [];
    }

    console.log('=== BACKEND DATA ===');
    console.log('trendData:', trendData);
    console.log('gradeData:', gradeData);
    console.log('violationTypeData:', violationTypeData);

    let autoRefreshEnabled = false;
    let refreshInterval;
    let charts = {};

    function animateCounters() {
        const counters = document.querySelectorAll('.counter');
        console.log('Found counters:', counters.length);

        counters.forEach((counter, index) => {
            const target = parseInt(counter.getAttribute('data-target')) || 0;
            console.log(`Counter ${index}: target=${target}, current text="${counter.textContent}"`);

            // Set the value immediately first
            counter.textContent = target;

            // Then animate from 0 to target
            let current = 0;
            const increment = target / 50;
            const duration = 1500; // 1.5 seconds
            const stepTime = duration / 50;

            if (target > 0) {
                counter.textContent = '0';
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        counter.textContent = target;
                        clearInterval(timer);
                    } else {
                        counter.textContent = Math.floor(current);
                    }
                }, stepTime);
            }
        });
    }

    function toggleAutoRefresh() {
        const btn = document.getElementById('autoRefreshBtn');
        autoRefreshEnabled = !autoRefreshEnabled;

        if (autoRefreshEnabled) {
            btn.textContent = 'Auto-Refresh: ON';
            btn.classList.remove('bg-blue-100', 'text-blue-700');
            btn.classList.add('bg-green-100', 'text-green-700');
            refreshInterval = setInterval(updateCharts, 60000);
        } else {
            btn.textContent = 'Auto-Refresh: OFF';
            btn.classList.remove('bg-green-100', 'text-green-700');
            btn.classList.add('bg-blue-100', 'text-blue-700');
            if (refreshInterval) clearInterval(refreshInterval);
        }
    }



    function createCharts() {
        const userRole = '{{ user.role }}';
        console.log('createCharts called for role:', userRole);

        // Check if canvas elements exist
        const allCanvases = document.querySelectorAll('canvas');
        console.log('Total canvas elements found:', allCanvases.length);
        allCanvases.forEach((canvas, index) => {
            console.log(`Canvas ${index}: id="${canvas.id}", width=${canvas.width}, height=${canvas.height}`);
        });

        if (userRole === 'do') {
            console.log('Calling createDOCharts()...');
            createDOCharts();
        } else if (userRole === 'counselor') {
            console.log('Calling createCounselorCharts()...');
            createCounselorCharts();
        } else if (userRole === 'esp_teacher') {
            console.log('Calling createESPCharts()...');
            createESPCharts();
        } else if (userRole === 'principal') {
            console.log('Calling createPrincipalCharts()...');
            createPrincipalCharts();
        }

        console.log('createCharts completed');
    }

    function createDOCharts() {
        console.log('Creating DO charts...');
        console.log('Trend Data:', trendData);
        console.log('Grade Data:', gradeData);
        console.log('Violation Type Data:', violationTypeData);

        // Trend Chart - Use real data
        const trendCtx = document.getElementById('doTrendChart');
        console.log('DO Trend Canvas:', trendCtx);

        if (trendCtx) {
            let localTrendData = trendData || [];
            if (localTrendData.length === 0) {
                console.warn('No trend data available, using sample data');
                localTrendData = [
                    { month: 'Jan', reports: 0 },
                    { month: 'Feb', reports: 0 },
                    { month: 'Mar', reports: 0 }
                ];
            }

            const labels = localTrendData.map(d => d.month);
            const data = localTrendData.map(d => d.reports);

            console.log('Creating DO trend chart with labels:', labels, 'data:', data);

            charts.doTrend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Violations',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Monthly Violation Reports' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            console.log('DO Trend chart created successfully');
        } else {
            console.error('DO Trend canvas not found!');
        }

        // Grade Chart - Use real data
        const gradeCtx = document.getElementById('doGradeChart');
        console.log('DO Grade Canvas:', gradeCtx);

        if (gradeCtx) {
            let localGradeData = gradeData;
            if (!localGradeData || localGradeData.length === 0) {
                console.warn('No grade data available, using sample data');
                localGradeData = [
                    { grade: 'Grade 7', count: 0 },
                    { grade: 'Grade 8', count: 0 },
                    { grade: 'Grade 9', count: 0 },
                    { grade: 'Grade 10', count: 0 },
                    { grade: 'Grade 11', count: 0 },
                    { grade: 'Grade 12', count: 0 }
                ];
            }

            const labels = localGradeData.map(d => d.grade);
            const data = localGradeData.map(d => d.count);

            console.log('Creating DO grade chart with labels:', labels, 'data:', data);

            charts.doGrade = new Chart(gradeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reports',
                        data: data,
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Reports by Grade Level' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            console.log('DO Grade chart created successfully');
        } else {
            console.error('DO Grade canvas not found!');
        }

        // Violation Type Chart - Use real data
        const violationCtx = document.getElementById('doViolationChart');
        console.log('DO Violation Canvas:', violationCtx);

        if (violationCtx) {
            let localViolationData = violationTypeData;
            if (!localViolationData || localViolationData.length === 0) {
                console.warn('No violation type data available, using sample data');
                localViolationData = [
                    { name: 'No Data', value: 0 }
                ];
            }

            const labels = localViolationData.slice(0, 5).map(d => d.name);
            const data = localViolationData.slice(0, 5).map(d => d.value);

            console.log('Creating DO violation chart with labels:', labels, 'data:', data);

            charts.doViolation = new Chart(violationCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Incidents',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Top 5 Violation Types' }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            console.log('DO Violation chart created successfully');
        } else {
            console.error('DO Violation canvas not found!');
        }
    }

    function createCounselorCharts() {
        console.log('Creating counselor charts...');
        console.log('Trend Data:', trendData);
        console.log('Grade Data:', gradeData);
        console.log('Violation Type Data:', violationTypeData);

        // Trend Chart - Use real data
        const trendCtx = document.getElementById('counselorTrendChart');
        console.log('Counselor Trend Canvas:', trendCtx);

        if (trendCtx) {
            let localTrendData = trendData || [];
            if (localTrendData.length === 0) {
                console.warn('No trend data available, using sample data');
                localTrendData = [
                    { month: 'Jan', reports: 0 },
                    { month: 'Feb', reports: 0 },
                    { month: 'Mar', reports: 0 }
                ];
            }

            const labels = localTrendData.map(d => d.month);
            const data = localTrendData.map(d => d.reports);

            console.log('Creating counselor trend chart with labels:', labels, 'data:', data);

            charts.counselorTrend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cases',
                        data: data,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'rgba(168, 85, 247, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Monthly Counseling Cases' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            console.log('Counselor Trend chart created successfully');
        } else {
            console.error('Counselor Trend canvas not found!');
        }

        // Grade Chart - Use real data
        const gradeCtx = document.getElementById('counselorGradeChart');
        console.log('Counselor Grade Canvas:', gradeCtx);

        if (gradeCtx) {
            let localGradeData = gradeData || [];
            if (localGradeData.length === 0) {
                console.warn('No grade data available, using sample data');
                localGradeData = [
                    { grade: 'Grade 7', count: 0 },
                    { grade: 'Grade 8', count: 0 },
                    { grade: 'Grade 9', count: 0 },
                    { grade: 'Grade 10', count: 0 },
                    { grade: 'Grade 11', count: 0 },
                    { grade: 'Grade 12', count: 0 }
                ];
            }

            const labels = localGradeData.map(d => d.grade);
            const data = localGradeData.map(d => d.count);

            console.log('Creating counselor grade chart with labels:', labels, 'data:', data);

            charts.counselorGrade = new Chart(gradeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cases',
                        data: data,
                        backgroundColor: ['#ef4444', '#f59e0b', '#22c55e', '#3b82f6', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Cases by Grade Level' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            console.log('Counselor Grade chart created successfully');
        } else {
            console.error('Counselor Grade canvas not found!');
        }

        // Incident Type Chart - Use real data
        const incidentCtx = document.getElementById('counselorIncidentChart');
        console.log('Counselor Incident Canvas:', incidentCtx);

        if (incidentCtx) {
            let localViolationData = violationTypeData || [];
            if (localViolationData.length === 0) {
                console.warn('No violation type data available, using sample data');
                localViolationData = [
                    { name: 'No Data', value: 0 }
                ];
            }

            const labels = localViolationData.slice(0, 5).map(d => d.name);
            const data = localViolationData.slice(0, 5).map(d => d.value);

            console.log('Creating counselor incident chart with labels:', labels, 'data:', data);

            charts.counselorIncident = new Chart(incidentCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cases',
                        data: data,
                        backgroundColor: 'rgba(168, 85, 247, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Top 5 Incident Types' }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            }
                        }
                    }
                }
            });
            console.log('Counselor Incident chart created successfully');
        } else {
            console.error('Counselor Incident canvas not found!');
        }
    }

    function createESPCharts() {
        // VPF Status Distribution - Pie Chart
        const vpfStatusCtx = document.getElementById('espVpfStatusChart');
        if (vpfStatusCtx) {
            const completedVPF = {{ completed_vpf|default: 0
        }
    };
    const pendingVPF = {{ pending_vpf|default: 0 }};

    charts.espVpfStatus = new Chart(vpfStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed VPF', 'Pending VPF'],
            datasets: [{
                data: [completedVPF, pendingVPF],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',  // Green for completed
                    'rgba(251, 146, 60, 0.8)'  // Orange for pending
                ],
                borderColor: [
                    'rgb(34, 197, 94)',
                    'rgb(251, 146, 60)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: { size: 12 }
                    }
                },
                title: {
                    display: true,
                    text: 'VPF Case Status Overview',
                    font: { size: 14 }
                }
            }
        }
    });
        }

    // VPF Improvement Rate - Line Chart
    const improvementCtx = document.getElementById('espImprovementChart');
    const vpfImprovementData = {{ vpf_improvement_data| safe }};

    if (improvementCtx && vpfImprovementData && vpfImprovementData.length > 0) {
        const labels = vpfImprovementData.map(d => d.month);
        const rates = vpfImprovementData.map(d => d.rate);

        charts.espImprovement = new Chart(improvementCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Completion Rate %',
                    data: rates,
                    borderColor: 'rgb(147, 51, 234)',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: 'rgb(147, 51, 234)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    title: {
                        display: true,
                        text: 'VPF Completion Rate Over Time',
                        font: { size: 14 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function (value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    }

    function createPrincipalCharts() {
        // Trend Chart - Use real data
        const trendCtx = document.getElementById('principalTrendChart');
        if (trendCtx && trendData) {
            const labels = trendData.map(d => d.month);
            const data = trendData.map(d => d.reports);

            charts.principalTrend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Incidents',
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Schoolwide Incident Trend' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Distribution Chart - Use real data from resolution data
        const distributionCtx = document.getElementById('principalDistributionChart');
        if (distributionCtx && resolutionData && resolutionData.length > 0) {
            // Calculate totals from resolution data
            const totalResolved = resolutionData.reduce((sum, d) => sum + d.resolved, 0);
            const totalPending = resolutionData.reduce((sum, d) => sum + d.pending, 0);

            charts.principalDistribution = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Resolved Cases', 'Pending Cases'],
                    datasets: [{
                        data: [totalResolved, totalPending],
                        backgroundColor: ['rgba(34, 197, 94, 0.8)', 'rgba(239, 68, 68, 0.8)']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Case Status Distribution' }
                    }
                }
            });
        }

        // Grade Chart - Use real data
        const gradeCtx = document.getElementById('principalGradeChart');
        if (gradeCtx && gradeData) {
            const labels = gradeData.map(d => d.grade);
            const data = gradeData.map(d => d.count);

            charts.principalGrade = new Chart(gradeCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Reports',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Reports by Grade Level' }
                    },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }

    function updateCharts() {
        Object.keys(charts).forEach(chartKey => {
            if (charts[chartKey] && charts[chartKey].data && charts[chartKey].data.datasets[0]) {
                const newData = charts[chartKey].data.datasets[0].data.map(() =>
                    Math.floor(Math.random() * 50) + 10
                );
                charts[chartKey].data.datasets[0].data = newData;
                charts[chartKey].update();
            }
        });
    }

    // Wait for both DOM and Chart.js to load
    window.addEventListener('load', function () {
        const userRole = '{{ user.role }}';
        console.log('Dashboard loaded for role:', userRole);

        // Log the data being passed from backend
        console.log('Backend data:');
        console.log('- Total reports: {{ total_reports|default:0 }}');
        console.log('- Pending: {{ pending|default:0 }}');
        console.log('- Minor cases: {{ minor_cases_count|default:0 }}');
        console.log('- Major cases: {{ major_cases_count|default:0 }}');

        if (userRole === 'do' || userRole === 'counselor' || userRole === 'esp_teacher' || userRole === 'principal') {
            // Give Chart.js a moment to initialize
            setTimeout(function () {
                console.log('Initializing charts...');
                console.log('Chart.js available:', typeof Chart !== 'undefined');

                if (typeof Chart === 'undefined') {
                    console.error('Chart.js failed to load');
                    const chartContainers = document.querySelectorAll('.chart-container');
                    chartContainers.forEach(container => {
                        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc2626; font-weight: bold;">‚ùå Chart.js failed to load</div>';
                    });
                    return;
                }

                try {
                    console.log('Animating counters...');
                    animateCounters();
                    console.log('Creating charts...');
                    console.log('Chart.js version:', Chart.version);
                    createCharts();
                    console.log('‚úÖ Dashboard charts loaded successfully');
                    console.log('Charts created:', Object.keys(charts));

                    // Verify charts were actually created
                    if (Object.keys(charts).length === 0) {
                        console.error('‚ö†Ô∏è No charts were created!');
                        const chartContainers = document.querySelectorAll('.chart-container');
                        chartContainers.forEach(container => {
                            if (!container.querySelector('canvas').chart) {
                                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #f59e0b; font-size: 14px;">‚ö†Ô∏è Chart failed to render</div>';
                            }
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Chart error:', error);
                    console.error('Error stack:', error.stack);
                    console.error('Error message:', error.message);

                    // Show error in chart containers
                    const chartContainers = document.querySelectorAll('.chart-container');
                    chartContainers.forEach(container => {
                        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc2626; font-size: 12px; text-align: center; padding: 10px;">‚ùå Error: ' + error.message + '</div>';
                    });
                }
            }, 100);
        }
    });
</script>
{% endblock %}