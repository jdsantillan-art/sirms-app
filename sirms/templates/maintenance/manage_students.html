{% extends 'base.html' %}

{% block title %}Manage Students - SIRMS{% endblock %}

{% block page_title %}Manage Students{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Header Section -->
    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-user-graduate text-blue-600"></i> Student Management
                </h2>
                <p class="text-gray-600 mt-1">Add, edit, or manage student records in the system</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="openBulkImportModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg flex items-center space-x-2 transition-colors shadow-md">
                    <i class="fas fa-file-upload"></i>
                    <span>Bulk Import</span>
                </button>
                <button onclick="openAddModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg flex items-center space-x-2 transition-colors shadow-md">
                    <i class="fas fa-plus"></i>
                    <span>Add New Student</span>
                </button>
            </div>
        </div>
        
        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-6">
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-blue-600 font-medium">Total Students</p>
                        <p class="text-2xl font-bold text-blue-700">{{ total_students }}</p>
                    </div>
                    <i class="fas fa-users text-3xl text-blue-400"></i>
                </div>
            </div>
            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-green-600 font-medium">Active Students</p>
                        <p class="text-2xl font-bold text-green-700">{{ active_students }}</p>
                    </div>
                    <i class="fas fa-user-check text-3xl text-green-400"></i>
                </div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-yellow-600 font-medium">With Violations</p>
                        <p class="text-2xl font-bold text-yellow-700">{{ students_with_violations }}</p>
                    </div>
                    <i class="fas fa-exclamation-triangle text-3xl text-yellow-400"></i>
                </div>
            </div>
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Inactive</p>
                        <p class="text-2xl font-bold text-gray-700">{{ inactive_students }}</p>
                    </div>
                    <i class="fas fa-user-times text-3xl text-gray-400"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex flex-wrap gap-3">
            <select id="gradeFilter" onchange="filterStudents()" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Grades</option>
                {% for i in "7891011 12"|make_list %}
                <option value="{{ i }}">Grade {{ i }}</option>
                {% endfor %}
            </select>
            <select id="statusFilter" onchange="filterStudents()" class="px-4 py-2 border border-gray-300 rounded-lg">
                <option value="">All Status</option>
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
            </select>
            <input type="text" id="searchInput" onkeyup="filterStudents()" placeholder="Search by name or username..." class="px-4 py-2 border border-gray-300 rounded-lg flex-1">
        </div>
    </div>
    
    <!-- Students List -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        {% if students %}
            <div class="overflow-x-auto">
                <table class="w-full" id="studentsTable">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Student ID</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Grade/Section</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase">Violations</th>
                            <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for student in students %}
                        <tr class="hover:bg-gray-50 transition-colors student-row" data-grade="{{ student.grade_level }}" data-status="{% if student.is_active %}active{% else %}inactive{% endif %}">
                            <td class="px-6 py-4">
                                <div class="text-sm font-mono font-medium text-gray-900">{{ student.username }}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="h-10 w-10 flex-shrink-0 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 font-semibold">{{ student.first_name|first }}{{ student.last_name|first }}</span>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-gray-900 student-name">{{ student.get_full_name }}</div>
                                        <div class="text-sm text-gray-500">{{ student.email }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                {% if student.grade_level %}
                                    Grade {{ student.grade_level }}
                                    {% if student.section %} - {{ student.section }}{% endif %}
                                {% else %}
                                    <span class="text-gray-400 italic">Not assigned</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-600">
                                {{ student.email|default:"Not provided" }}
                            </td>
                            <td class="px-6 py-4">
                                {% if student.is_active %}
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                        <i class="fas fa-check-circle mr-1"></i> Active
                                    </span>
                                {% else %}
                                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                        <i class="fas fa-times-circle mr-1"></i> Inactive
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-sm">
                                {% if student.violation_count > 0 %}
                                    <span class="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-semibold">
                                        {{ student.violation_count }} violation{{ student.violation_count|pluralize }}
                                    </span>
                                {% else %}
                                    <span class="text-gray-400 text-xs">No violations</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                                <button onclick="openEditModal({{ student.id }}, '{{ student.username|escapejs }}', '{{ student.first_name|escapejs }}', '{{ student.last_name|escapejs }}', '{{ student.email|escapejs }}', '{{ student.grade_level|escapejs }}', '{{ student.section|escapejs }}', {{ student.is_active|yesno:'true,false' }})" 
                                        class="text-blue-600 hover:text-blue-900 transition-colors">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <a href="{% url 'report_detail' student.id %}" class="text-green-600 hover:text-green-900 transition-colors">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-12">
                <i class="fas fa-user-graduate text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">No students found</p>
                <p class="text-gray-400 mt-2">Click "Add New Student" to get started</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Student Modal -->
<div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b sticky top-0 bg-white">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-user-plus text-blue-600"></i> Add New Student
                </h3>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form method="POST" class="p-6">
            {% csrf_token %}
            <input type="hidden" name="action" value="add_student">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user"></i> First Name *
                    </label>
                    <input type="text" name="first_name" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user"></i> Last Name *
                    </label>
                    <input type="text" name="last_name" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-id-card"></i> Username/Student ID *
                    </label>
                    <input type="text" name="username" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope"></i> Email
                    </label>
                    <input type="email" name="email" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-graduation-cap"></i> Grade Level *
                    </label>
                    <select name="grade_level" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Grade</option>
                        {% for i in "7891011 12"|make_list %}
                        <option value="{{ i }}">Grade {{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-users"></i> Section
                    </label>
                    <input type="text" name="section" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., A, B, Einstein">
                </div>
                
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key"></i> Password *
                    </label>
                    <input type="password" name="password" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Default password for the student">
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeAddModal()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Student
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Student Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b sticky top-0 bg-white">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-edit text-blue-600"></i> Edit Student
                </h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <form method="POST" class="p-6">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit_student">
            <input type="hidden" id="edit_student_id" name="student_id">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user"></i> First Name *
                    </label>
                    <input type="text" id="edit_first_name" name="first_name" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user"></i> Last Name *
                    </label>
                    <input type="text" id="edit_last_name" name="last_name" required 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-id-card"></i> Username/Student ID
                    </label>
                    <input type="text" id="edit_username" name="username" readonly 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope"></i> Email
                    </label>
                    <input type="email" id="edit_email" name="email" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-graduation-cap"></i> Grade Level
                    </label>
                    <select id="edit_grade_level" name="grade_level" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Select Grade</option>
                        {% for i in "7891011 12"|make_list %}
                        <option value="{{ i }}">Grade {{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-users"></i> Section
                    </label>
                    <input type="text" id="edit_section" name="section" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <div class="md:col-span-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="edit_is_active" name="is_active" 
                               class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="edit_is_active" class="ml-2 block text-sm text-gray-700">
                            Active (student can login and use the system)
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" onclick="closeEditModal()" 
                        class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal Functions
function openAddModal() {
    document.getElementById('addModal').classList.remove('hidden');
    document.getElementById('addModal').classList.add('flex');
}

function closeAddModal() {
    document.getElementById('addModal').classList.add('hidden');
    document.getElementById('addModal').classList.remove('flex');
}

function openEditModal(id, username, firstName, lastName, email, gradeLevel, section, isActive) {
    document.getElementById('edit_student_id').value = id;
    document.getElementById('edit_username').value = username;
    document.getElementById('edit_first_name').value = firstName;
    document.getElementById('edit_last_name').value = lastName;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_grade_level').value = gradeLevel;
    document.getElementById('edit_section').value = section;
    document.getElementById('edit_is_active').checked = isActive;
    
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editModal').classList.add('flex');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editModal').classList.remove('flex');
}

function openBulkImportModal() {
    alert('Bulk import feature coming soon! You can import students from CSV/Excel files.');
}

// Filter Functions
function filterStudents() {
    const gradeFilter = document.getElementById('gradeFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const searchInput = document.getElementById('searchInput').value.toLowerCase();
    
    const rows = document.querySelectorAll('.student-row');
    
    rows.forEach(row => {
        const grade = row.getAttribute('data-grade');
        const status = row.getAttribute('data-status');
        const name = row.querySelector('.student-name').textContent.toLowerCase();
        
        const gradeMatch = !gradeFilter || grade === gradeFilter;
        const statusMatch = !statusFilter || status === statusFilter;
        const searchMatch = !searchInput || name.includes(searchInput);
        
        if (gradeMatch && statusMatch && searchMatch) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Close modals on escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAddModal();
        closeEditModal();
    }
});
</script>
{% endblock %}
