{% extends 'base.html' %}
{% load dict_extras %}

{% block title %}Advisee Records - SIRMS{% endblock %}

{% block content %}
<div class="max-w-6xl">
    <h1 class="text-4xl font-bold text-green-700 mb-8">üë• Advisee Records</h1>
    
    <!-- Statistics Overview -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="card bg-blue-50 border-blue-200">
            <div class="flex items-center">
                <div class="text-3xl text-blue-600 mr-4">üìä</div>
                <div>
                    <h3 class="text-lg font-bold text-blue-800">Total Incidents</h3>
                    <p class="text-2xl font-bold text-blue-600">{{ total_incidents }}</p>
                </div>
            </div>
        </div>
        <div class="card bg-yellow-50 border-yellow-200">
            <div class="flex items-center">
                <div class="text-3xl text-yellow-600 mr-4">‚è≥</div>
                <div>
                    <h3 class="text-lg font-bold text-yellow-800">Pending Cases</h3>
                    <p class="text-2xl font-bold text-yellow-600">{{ pending_incidents }}</p>
                </div>
            </div>
        </div>
        <div class="card bg-green-50 border-green-200">
            <div class="flex items-center">
                <div class="text-3xl text-green-600 mr-4">‚úÖ</div>
                <div>
                    <h3 class="text-lg font-bold text-green-800">Resolved Cases</h3>
                    <p class="text-2xl font-bold text-green-600">{{ resolved_incidents }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Advised Sections Overview -->
    <div class="card mb-6">
        <h2 class="text-2xl font-bold text-green-700 mb-4">Your Advised Sections</h2>
        
        {% if advised_sections %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for section in advised_sections %}
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="font-bold text-gray-800">{{ section.name }}</h3>
                    <p class="text-gray-600">{{ section.grade }}</p>
                    <div class="mt-2 text-sm space-y-1">
                        {% with section_data=section_stats|get_item:section.name %}
                            {% if section_data.total %}
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Total:</span>
                                    <span class="font-bold">{{ section_data.total }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-yellow-600">Pending:</span>
                                    <span class="font-bold text-yellow-600">{{ section_data.pending }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-green-600">Resolved:</span>
                                    <span class="font-bold text-green-600">{{ section_data.resolved }}</span>
                                </div>
                            {% else %}
                                <span class="text-green-600">‚úÖ No violations</span>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <div class="text-gray-500">No sections assigned as adviser.</div>
                <p class="text-gray-400 text-sm mt-2">Contact administration to assign advisory sections.</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Guidance Referrals -->
    {% if referred_sessions %}
    <div class="card mb-6">
        <h2 class="text-2xl font-bold text-orange-700 mb-4">üîÑ Guidance Referrals - Classroom Monitoring Required</h2>
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
            <p class="text-orange-800 text-sm">
                <strong>Note:</strong> These cases have been referred back to you by the Guidance Office for classroom monitoring and follow-up.
            </p>
        </div>
        <div class="space-y-3">
            {% for session in referred_sessions %}
            <div class="border border-orange-200 rounded-lg p-4 bg-orange-50">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <h4 class="font-bold text-gray-800">{{ session.student.get_full_name }}</h4>
                        <p class="text-sm text-gray-600">Case: {{ session.report.case_id }} | Referred: {{ session.scheduled_date|date:"M d, Y" }}</p>
                        {% if session.remarks %}
                        <p class="text-sm text-orange-700 mt-2"><strong>Guidance Notes:</strong> {{ session.remarks }}</p>
                        {% endif %}
                    </div>
                    <div class="ml-4">
                        <a href="{% url 'report_detail' session.report.case_id %}" class="bg-orange-600 text-white px-3 py-1 rounded text-sm hover:bg-orange-700">
                            View Case
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Advisee Violation Reports -->
    <div class="card">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-green-700">Advisee Incident Reports</h2>
            <div class="flex space-x-2">
                <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm" onchange="filterReports()">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="under_review">Under Review</option>
                    <option value="classified">Classified</option>
                    <option value="evaluated">Evaluated</option>
                    <option value="sanctioned">Sanctioned</option>
                    <option value="resolved">Resolved</option>
                </select>
                <select id="type-filter" class="px-3 py-2 border border-gray-300 rounded-md text-sm" onchange="filterReports()">
                    <option value="">All Types</option>
                    {% for report in advisee_reports %}
                        {% if report.incident_type %}
                            <option value="{{ report.incident_type.name }}">{{ report.incident_type.name }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
        
        {% if advisee_reports %}
            <div class="space-y-4">
                {% for report in advisee_reports %}
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors report-item" 
                     data-status="{{ report.status }}" 
                     data-type="{% if report.incident_type %}{{ report.incident_type.name }}{% endif %}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <h3 class="text-lg font-bold text-gray-800">Case {{ report.case_id }}</h3>
                                <span class="px-2 py-1 text-xs rounded-full {% if report.status == 'pending' %}bg-yellow-100 text-yellow-800{% elif report.status == 'resolved' %}bg-green-100 text-green-800{% elif report.status == 'sanctioned' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ report.get_status_display }}
                                </span>
                                {% if report.created_at|timesince|slice:":1" == "0" %}
                                <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800">NEW</span>
                                {% endif %}
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mb-3">
                                <div>
                                    <span class="font-medium">Student:</span> 
                                    {% if report.reported_student %}
                                        {{ report.reported_student.get_full_name }}
                                    {% else %}
                                        {{ report.involved_students|default:"Not specified" }}
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="font-medium">Section:</span> {{ report.section_name|default:"Not specified" }}
                                </div>
                                <div>
                                    <span class="font-medium">Incident Type:</span> 
                                    {% if report.incident_type %}
                                        {{ report.incident_type.name }}
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </div>
                                <div>
                                    <span class="font-medium">Reported by:</span> {{ report.reporter.get_full_name }}
                                </div>
                                <div>
                                    <span class="font-medium">Date:</span> {{ report.incident_date|date:"M d, Y" }}
                                </div>
                                <div>
                                    <span class="font-medium">Filed:</span> {{ report.created_at|date:"M d, Y H:i" }}
                                </div>
                            </div>
                            
                            {% if report.description %}
                            <div class="mb-3">
                                <span class="font-medium text-gray-700">Description:</span>
                                <p class="text-gray-700 text-sm mt-1">{{ report.description|truncatewords:30 }}</p>
                            </div>
                            {% endif %}
                            
                            <!-- Actions Taken -->
                            <div class="flex flex-wrap gap-2 text-xs">
                                {% if report.classification %}
                                <span class="px-2 py-1 bg-purple-100 text-purple-800 rounded">
                                    Classified: {{ report.classification.get_severity_display }}
                                </span>
                                {% endif %}
                                
                                {% if report.counseling_sessions.exists %}
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">
                                    Counseling: {{ report.counseling_sessions.count }} session(s)
                                </span>
                                {% endif %}
                                
                                {% if report.sanction %}
                                <span class="px-2 py-1 bg-red-100 text-red-800 rounded">
                                    Sanctioned: {{ report.sanction.sanction_type }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="ml-4 flex flex-col space-y-2">
                            <a href="{% url 'report_detail' report.case_id %}" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 transition-colors text-center">
                                üëÅÔ∏è View Full Details
                            </a>
                            {% if report.status == 'pending' or report.status == 'under_review' %}
                            <button class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700 transition-colors" onclick="addTeacherNote('{{ report.case_id }}')">
                                üìù Add Note
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <div class="text-gray-500 text-lg">No incident reports for your advisees.</div>
                <p class="text-gray-400 mt-2">Great job maintaining discipline in your sections! üåü</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Quick Actions -->
    <div class="card mt-6">
        <h3 class="text-xl font-bold text-green-700 mb-4">üöÄ Quick Actions</h3>
        <div class="grid grid-cols-3 gap-4">
            <a href="{% url 'report_incident' %}" class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-center">
                <div class="text-2xl mb-2">üìù</div>
                <h4 class="font-bold text-gray-800">Report New Incident</h4>
                <p class="text-gray-600 text-sm">File a new violation report</p>
            </a>
            <a href="{% url 'counseling_schedule' %}" class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-center">
                <div class="text-2xl mb-2">üìÖ</div>
                <h4 class="font-bold text-gray-800">View Counseling Schedule</h4>
                <p class="text-gray-600 text-sm">Check upcoming sessions</p>
            </a>
            <a href="{% url 'my_reports' %}" class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-center">
                <div class="text-2xl mb-2">üìã</div>
                <h4 class="font-bold text-gray-800">My Reports</h4>
                <p class="text-gray-600 text-sm">View reports I've filed</p>
            </a>
        </div>
    </div>
</div>

<script>
function filterReports() {
    const statusFilter = document.getElementById('status-filter').value;
    const typeFilter = document.getElementById('type-filter').value;
    const reportItems = document.querySelectorAll('.report-item');
    
    reportItems.forEach(item => {
        const itemStatus = item.getAttribute('data-status');
        const itemType = item.getAttribute('data-type');
        
        let showItem = true;
        
        if (statusFilter && itemStatus !== statusFilter) {
            showItem = false;
        }
        
        if (typeFilter && itemType !== typeFilter) {
            showItem = false;
        }
        
        item.style.display = showItem ? 'block' : 'none';
    });
}

function addTeacherNote(caseId) {
    const note = prompt('Add a note about this case (this will be visible to the Discipline Office):');
    if (note && note.trim()) {
        // Here you would typically send an AJAX request to save the note
        // For now, we'll just show a confirmation
        alert('Note added successfully! The Discipline Office will be notified.');
        
        // You can implement the actual AJAX call here
        // fetch('/add-teacher-note/', {
        //     method: 'POST',
        //     headers: {
        //         'Content-Type': 'application/json',
        //         'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        //     },
        //     body: JSON.stringify({
        //         case_id: caseId,
        //         note: note
        //     })
        // });
    }
}

// Auto-refresh every 5 minutes to check for new incidents
setInterval(function() {
    // You can implement auto-refresh logic here if needed
    // location.reload();
}, 300000); // 5 minutes

// Highlight new incidents
document.addEventListener('DOMContentLoaded', function() {
    const newItems = document.querySelectorAll('.report-item:has(.bg-red-100)');
    newItems.forEach(item => {
        item.style.animation = 'pulse 2s infinite';
    });
});
</script>

<style>
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
    100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
}
</style>

{% endblock %}