{% extends 'base.html' %}

{% block title %}Report Detail - {{ report.case_id }} - SIRMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Compact Header -->
    <div class="flex justify-between items-center mb-3">
        <h1 class="text-xl font-bold text-gray-900">üìã Report {{ report.case_id }}</h1>
        <div class="flex space-x-2">
            <button onclick="history.back()" class="bg-gray-500 text-white px-3 py-1.5 rounded text-sm hover:bg-gray-600">
                ‚Üê Back
            </button>
            <button onclick="window.print()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">
                üñ®Ô∏è Print
            </button>
        </div>
    </div>
    
    <!-- Compact Summary Cards -->
    <div class="grid grid-cols-4 gap-2 mb-2">
        <div class="bg-white border rounded p-1.5 text-center">
            <div class="text-sm font-bold text-blue-600">{{ report.case_id }}</div>
            <div class="text-xs text-gray-600">Case ID</div>
        </div>
        <div class="bg-white border rounded p-1.5 text-center">
            <div class="text-sm font-bold {% if classification.severity == 'major' %}text-red-600{% else %}text-yellow-600{% endif %}">
                {% if classification %}{{ classification.get_severity_display }}{% else %}Pending{% endif %}
            </div>
            <div class="text-xs text-gray-600">Priority</div>
        </div>
        <div class="bg-white border rounded p-1.5 text-center">
            <div class="text-sm font-bold text-green-600">{{ report.created_at|timesince }}</div>
            <div class="text-xs text-gray-600">Age</div>
        </div>
        <div class="bg-white border rounded p-1.5 text-center">
            <div class="text-sm font-bold {% if report.status == 'resolved' %}text-green-600{% elif report.status == 'sanctioned' %}text-red-600{% elif report.status == 'evaluated' %}text-purple-600{% else %}text-orange-600{% endif %}">
                {{ report.get_status_display }}
            </div>
            <div class="text-xs text-gray-600">Status</div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-2">
        <!-- Main Report Information -->
        <div class="lg:col-span-2">
            <!-- Basic Information -->
            <div class="bg-white rounded-lg shadow-sm border p-2 mb-2">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h2 class="text-base font-bold text-gray-800">{{ report.incident_type.name }}</h2>
                        <p class="text-xs text-gray-500">{{ report.created_at|date:"M d, Y H:i" }}</p>
                    </div>
                    <span class="px-2 py-1 rounded text-xs font-semibold {% if report.status == 'pending' %}bg-yellow-100 text-yellow-800{% elif report.status == 'resolved' %}bg-green-100 text-green-800{% elif report.status == 'sanctioned' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                        {{ report.get_status_display }}
                    </span>
                </div>
                
                <div class="grid grid-cols-2 gap-2 text-xs mb-1">
                    <div>
                        <span class="font-semibold text-gray-700">Reporter:</span>
                        <p class="text-gray-900">{{ report.reporter_first_name }} {{ report.reporter_last_name }}</p>
                        <p class="text-gray-500">{{ report.reporter.get_role_display }}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Incident:</span>
                        <p class="text-gray-900">{{ report.incident_date|date:"M d, Y" }} {{ report.incident_time|time:"g:i A" }}</p>
                        <p class="text-gray-500">G{{ report.grade_level }} - {{ report.section_name }}</p>
                    </div>
                </div>
                
                {% if report.involved_students %}
                <div class="mb-1">
                    <span class="text-xs font-semibold text-gray-700">Involved Students:</span>
                    <div class="bg-blue-50 p-1.5 rounded text-xs">
                        <div class="flex items-center justify-between">
                            <p class="text-gray-700">{{ report.involved_students }}</p>
                            {% if is_repeat_offender %}
                            <span class="inline-flex items-center px-2 py-1 text-xs font-bold rounded-full bg-red-100 text-red-800 border border-red-300">
                                <i class="fas fa-exclamation-triangle mr-1"></i>REPEATED OFFENDER ({{ repeat_count }}x previous)
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if report.description %}
                <div class="mb-1">
                    <span class="text-xs font-semibold text-gray-700">Description:</span>
                    <div class="bg-gray-50 p-1.5 rounded text-xs">
                        <p class="text-gray-700 line-clamp-3">{{ report.description }}</p>
                    </div>
                </div>
                {% endif %}
                
                {% if report.evidence %}
                <div>
                    <a href="{{ report.evidence.url }}" target="_blank" class="inline-flex items-center text-xs text-blue-600 hover:underline">
                        üìé View Evidence
                    </a>
                </div>
                {% endif %}
            </div>
            
            <!-- Student & Academic Information -->
            {% if report.reported_student %}
            <div class="bg-white rounded-lg shadow-sm border p-2 mb-2">
                <h3 class="text-sm font-bold text-gray-900 mb-1">üë§ Student Information</h3>
                <div class="bg-blue-50 p-1.5 rounded">
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div>
                            <span class="font-semibold text-gray-700">Name:</span>
                            <p class="text-gray-900">{{ report.reported_student.get_full_name }}</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">ID:</span>
                            <p class="text-gray-900 font-mono">{{ report.reported_student.username }}</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Email:</span>
                            <p class="text-gray-900 text-xs">{{ report.reported_student.email|default:"N/A" }}</p>
                        </div>
                        <div>
                            <span class="font-semibold text-gray-700">Grade/Section:</span>
                            <p class="text-gray-900">G{{ report.grade_level }} - {{ report.section_name }}</p>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="bg-white rounded-lg shadow-sm border p-2 mb-2">
                <h3 class="text-sm font-bold text-gray-900 mb-1">üéì Academic Information</h3>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <div>
                        <span class="font-semibold text-gray-700">Curriculum:</span>
                        <p class="text-gray-900">{{ report.curriculum.name|default:"N/A" }}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Grade/Section:</span>
                        <p class="text-gray-900">G{{ report.grade_level }} - {{ report.section_name }}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Teacher:</span>
                        <p class="text-gray-900">{{ report.teacher_name|default:"N/A" }}</p>
                    </div>
                    <div>
                        <span class="font-semibold text-gray-700">Track:</span>
                        <p class="text-gray-900">{{ report.track.name|default:"N/A" }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Classification (if exists) -->
            {% if classification %}
            <div class="bg-white rounded-lg shadow-sm border p-2 mb-2">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-sm font-bold text-gray-900">üè∑Ô∏è Classification</h3>
                    <span class="px-2 py-1 text-xs rounded {% if classification.severity == 'major' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                        {{ classification.get_severity_display }}
                    </span>
                </div>
                <div class="bg-yellow-50 p-2 rounded text-xs">
                    {% if classification.internal_notes %}
                    <p class="text-gray-700 mb-1">{{ classification.internal_notes }}</p>
                    {% endif %}
                    <p class="text-gray-500">
                        By: {{ classification.classified_by.get_full_name }} | {{ classification.classified_at|date:"M d, Y" }}
                    </p>
                </div>
            </div>
            {% endif %}
            
            <!-- Case Evaluation (if exists) -->
            {% if report.evaluation %}
            <div class="bg-white rounded-lg shadow-sm border p-2 mb-2">
                <h3 class="text-sm font-bold text-gray-900 mb-2">üìã Counselor Evaluation</h3>
                <div class="bg-blue-50 p-2 rounded border-l-4 border-blue-400 text-xs">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <h4 class="font-bold text-gray-700">Recommendation:</h4>
                            <span class="px-3 py-2 text-sm rounded font-semibold
                                {% if report.evaluation.recommendation == 'sanction' %}bg-red-100 text-red-800
                                {% elif report.evaluation.recommendation == 'counseling' %}bg-blue-100 text-blue-800
                                {% elif report.evaluation.recommendation == 'monitoring' %}bg-yellow-100 text-yellow-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ report.evaluation.get_recommendation_display }}
                            </span>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-700">Repeat Offender:</h4>
                            <span class="px-3 py-2 text-sm rounded font-semibold {% if report.evaluation.is_repeat_offender %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                                {% if report.evaluation.is_repeat_offender %}Yes ‚ö†Ô∏è{% else %}No ‚úÖ{% endif %}
                            </span>
                        </div>
                    </div>
                    {% if report.evaluation.evaluation_notes %}
                    <div class="mb-3">
                        <h4 class="font-bold text-gray-700 mb-2">Evaluation Notes:</h4>
                        <div class="bg-white p-3 rounded border">
                            <p class="text-gray-700">{{ report.evaluation.evaluation_notes }}</p>
                        </div>
                    </div>
                    {% endif %}
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mt-3">
                        <div>
                            <strong>Evaluated by:</strong> {{ report.evaluation.evaluated_by.get_full_name }}
                        </div>
                        <div>
                            <strong>Evaluation Date:</strong> {{ report.evaluation.evaluated_at|date:"M d, Y H:i" }}
                        </div>
                    </div>
                    
                    <!-- Next Steps based on recommendation -->
                    <div class="mt-4 p-3 bg-white rounded border">
                        <h4 class="font-bold text-gray-700 mb-2">üìã Next Steps:</h4>
                        {% if report.evaluation.recommendation == 'sanction' %}
                            <p class="text-red-700">‚öñÔ∏è This case requires disciplinary action. Proceed to sanction management.</p>
                        {% elif report.evaluation.recommendation == 'counseling' %}
                            <p class="text-blue-700">üó£Ô∏è Student requires counseling sessions. Schedule appropriate counseling.</p>
                        {% elif report.evaluation.recommendation == 'monitoring' %}
                            <p class="text-yellow-700">üëÄ Student should be placed under monitoring. Regular check-ins required.</p>
                        {% else %}
                            <p class="text-green-700">‚úÖ Case can be resolved with current measures.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Sanction Information (if exists) -->
            {% if report.sanction %}
            <div class="card mb-6">
                <h3 class="text-xl font-bold text-green-700 mb-4">‚öñÔ∏è Sanction Details</h3>
                <div class="bg-red-50 p-4 rounded border-l-4 border-red-400">
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <h4 class="font-bold text-gray-700">Sanction Type:</h4>
                            <span class="px-3 py-1 text-sm rounded bg-red-100 text-red-800 font-semibold">
                                {{ report.sanction.get_sanction_type_display }}
                            </span>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-700">Duration:</h4>
                            <p class="text-gray-900 font-semibold">
                                {% if report.sanction.duration_days %}
                                    {{ report.sanction.duration_days }} day{{ report.sanction.duration_days|pluralize }}
                                {% else %}
                                    N/A
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    {% if report.sanction.reason %}
                    <div class="mb-3">
                        <h4 class="font-bold text-gray-700 mb-2">Reason for Sanction:</h4>
                        <p class="text-gray-700">{{ report.sanction.reason }}</p>
                    </div>
                    {% endif %}
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                        <div>
                            <strong>Issued by:</strong> {{ report.sanction.issued_by.get_full_name }}
                        </div>
                        <div>
                            <strong>Issued on:</strong> {{ report.sanction.issued_at|date:"M d, Y H:i" }}
                        </div>
                    </div>
                    {% if report.sanction.start_date %}
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-600 mt-2">
                        <div>
                            <strong>Start Date:</strong> {{ report.sanction.start_date|date:"M d, Y" }}
                        </div>
                        {% if report.sanction.end_date %}
                        <div>
                            <strong>End Date:</strong> {{ report.sanction.end_date|date:"M d, Y" }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Counseling Sessions (if any) -->
            {% if counseling_sessions %}
            <div class="card mb-6">
                <h3 class="text-xl font-bold text-green-700 mb-4">üó£Ô∏è Counseling Sessions</h3>
                <div class="space-y-3">
                    {% for session in counseling_sessions %}
                    <div class="bg-green-50 p-4 rounded border-l-4 border-green-400">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h4 class="font-bold text-gray-700">Session {{ forloop.counter }}</h4>
                                <p class="text-sm text-gray-600">{{ session.scheduled_date|date:"M d, Y H:i" }}</p>
                            </div>
                            <span class="px-2 py-1 text-xs rounded {% if session.status == 'completed' %}bg-green-100 text-green-800{% elif session.status == 'scheduled' %}bg-blue-100 text-blue-800{% elif session.status == 'cancelled' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ session.get_status_display }}
                            </span>
                        </div>
                        {% if session.remarks %}
                        <p class="text-gray-700 mb-2">{{ session.remarks }}</p>
                        {% endif %}
                        <p class="text-sm text-gray-500">
                            Counselor: {{ session.counselor.get_full_name }}
                        </p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Internal Notes (for authorized users) -->
            {% if internal_notes and user.role in 'do,counselor,principal' %}
            <div class="card mb-6">
                <h3 class="text-xl font-bold text-green-700 mb-4">üìù Internal Notes</h3>
                <div class="space-y-3">
                    {% for note in internal_notes %}
                    <div class="bg-gray-50 p-4 rounded border-l-4 border-gray-400">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-gray-700">{{ note.author.get_full_name }}</h4>
                            <span class="text-sm text-gray-500">{{ note.created_at|date:"M d, Y H:i" }}</span>
                        </div>
                        <p class="text-gray-700">{{ note.note }}</p>
                        {% if note.is_private %}
                        <span class="inline-block mt-2 px-2 py-1 text-xs rounded bg-red-100 text-red-800">
                            üîí Private
                        </span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Status & Actions Sidebar -->
        <div class="lg:col-span-1">
            <div class="card sticky top-4">
                <h3 class="text-xl font-bold text-green-700 mb-4">üìä Case Status & Timeline</h3>
                
                <!-- Status Timeline -->
                <div class="space-y-3 mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                        <div>
                            <p class="font-semibold text-sm">Report Submitted</p>
                            <p class="text-xs text-gray-500">{{ report.created_at|date:"M d, Y H:i" }}</p>
                        </div>
                    </div>
                    
                    {% if report.status != 'pending' %}
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                        <div>
                            <p class="font-semibold text-sm">Under Review</p>
                            <p class="text-xs text-gray-500">Processing...</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if classification %}
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
                        <div>
                            <p class="font-semibold text-sm">Classified</p>
                            <p class="text-xs text-gray-500">{{ classification.classified_at|date:"M d, Y H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if report.evaluation %}
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                        <div>
                            <p class="font-semibold text-sm">Evaluated</p>
                            <p class="text-xs text-gray-500">{{ report.evaluation.evaluated_at|date:"M d, Y H:i" }}</p>
                            <p class="text-xs text-purple-600 font-semibold">{{ report.evaluation.get_recommendation_display }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if report.sanction %}
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                        <div>
                            <p class="font-semibold text-sm">Sanctioned</p>
                            <p class="text-xs text-gray-500">{{ report.sanction.issued_at|date:"M d, Y H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if counseling_sessions %}
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-indigo-500 rounded-full"></div>
                        <div>
                            <p class="font-semibold text-sm">Counseling Scheduled</p>
                            <p class="text-xs text-gray-500">{{ counseling_sessions|length }} session{{ counseling_sessions|length|pluralize }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if report.status == 'resolved' %}
                    <div class="flex items-center space-x-3">
                        <div class="w-3 h-3 bg-green-600 rounded-full"></div>
                        <div>
                            <p class="font-semibold text-sm">Resolved</p>
                            <p class="text-xs text-gray-500">Case closed</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Quick Stats -->
                <div class="p-3 bg-gray-50 rounded">
                    <h4 class="font-bold text-gray-700 mb-2">üìã Quick Info</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Case ID:</span>
                            <span class="font-semibold font-mono">{{ report.case_id }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Status:</span>
                            <span class="font-semibold">{{ report.get_status_display }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Priority:</span>
                            <span class="font-semibold {% if classification.severity == 'major' %}text-red-600{% else %}text-yellow-600{% endif %}">
                                {% if classification %}{{ classification.get_severity_display }}{% else %}Pending{% endif %}
                            </span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Days Open:</span>
                            <span class="font-semibold">{{ report.created_at|timesince }}</span>
                        </div>
                        {% if report.reported_student %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Student:</span>
                            <span class="font-semibold">{{ report.reported_student.get_full_name }}</span>
                        </div>
                        {% endif %}
                        {% if report.evaluation %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Recommendation:</span>
                            <span class="font-semibold {% if report.evaluation.recommendation == 'sanction' %}text-red-600{% elif report.evaluation.recommendation == 'counseling' %}text-blue-600{% elif report.evaluation.recommendation == 'monitoring' %}text-yellow-600{% else %}text-green-600{% endif %}">
                                {{ report.evaluation.get_recommendation_display }}
                            </span>
                        </div>
                        {% endif %}
                        {% if report.evaluation.is_repeat_offender %}
                        <div class="flex justify-between">
                            <span class="text-gray-600">Repeat:</span>
                            <span class="font-semibold text-red-600">‚ö†Ô∏è Yes</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Case Statistics -->
                {% if user.role in 'counselor,principal' %}
                <div class="p-3 bg-blue-50 rounded mt-4">
                    <h4 class="font-bold text-blue-700 mb-2">üìà Case Statistics</h4>
                    <div class="space-y-1 text-sm">
                        {% if counseling_sessions %}
                        <div class="flex justify-between">
                            <span class="text-blue-600">Counseling Sessions:</span>
                            <span class="font-semibold">{{ counseling_sessions|length }}</span>
                        </div>
                        {% endif %}
                        {% if internal_notes %}
                        <div class="flex justify-between">
                            <span class="text-blue-600">Internal Notes:</span>
                            <span class="font-semibold">{{ internal_notes|length }}</span>
                        </div>
                        {% endif %}
                        {% if report.sanction %}
                        <div class="flex justify-between">
                            <span class="text-blue-600">Sanction Type:</span>
                            <span class="font-semibold text-red-600">{{ report.sanction.get_sanction_type_display }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Actions (if user has permissions) -->
                {% if user.role == 'do' and not classification %}
                <div class="mt-4 p-3 bg-blue-50 rounded">
                    <h4 class="font-bold text-blue-700 mb-2">Available Actions</h4>
                    <p class="text-sm text-blue-600 mb-3">This report is ready for classification.</p>
                    
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Classification Form (for DO users) -->
    {% if user.role == 'do' and not classification %}
   
    {% endif %}
</div>

<style>
.line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}