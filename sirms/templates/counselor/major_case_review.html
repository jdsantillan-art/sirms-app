{% extends 'base.html' %}

{% block title %}All Reports - SIRMS{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <!-- Compact Statistics -->
    <div class="grid grid-cols-4 gap-3 mb-4">
        <div class="bg-white rounded-lg shadow-sm border p-3 text-center">
            <div class="text-xl font-bold text-red-600">{{ cases.count }}</div>
            <div class="text-gray-600 text-xs">Major Cases</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-3 text-center">
            <div class="text-xl font-bold text-orange-600">{{ pending_evaluation }}</div>
            <div class="text-gray-600 text-xs">Pending</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-3 text-center">
            <div class="text-xl font-bold text-blue-600">{{ repeat_offenders }}</div>
            <div class="text-gray-600 text-xs">Repeat</div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border p-3 text-center">
            <div class="text-xl font-bold text-green-600">{{ evaluated_today }}</div>
            <div class="text-gray-600 text-xs">Today</div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border">
        <div class="p-4 border-b">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-900">All Reports ({{ total_reports }})</h2>
                <a href="?export=excel{% if search_query %}&search={{ search_query }}{% endif %}"
                    class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 flex items-center">
                    <i class="fas fa-file-excel mr-2"></i>Export to Excel
                </a>
            </div>

            <!-- Search Bar -->
            <div class="flex space-x-2">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="ðŸ” Search by Name or LRN..."
                        value="{{ search_query }}" class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                        onkeyup="performSearch()">
                </div>
                <select id="filter-type" class="px-2 py-1 border border-gray-300 rounded text-sm"
                    onchange="filterCases()">
                    <option value="">All Types</option>
                    {% for case in cases %}
                    {% if case.incident_type %}
                    <option value="{{ case.incident_type.name }}">{{ case.incident_type.name }}</option>
                    {% endif %}
                    {% endfor %}
                </select>
                <select id="filter-grade" class="px-2 py-1 border border-gray-300 rounded text-sm"
                    onchange="filterCases()">
                    <option value="">All Grades</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
            </div>
        </div>

        {% if cases %}
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Referral ID</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Student Name</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Incident</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Type</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Grade/Section</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Date</th>
                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Action</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="cases-table">
                    {% for case in cases %}
                    <tr class="hover:bg-gray-50 case-row {% if case.reported_student and case.reported_student.id in repeat_offender_ids %}bg-red-50{% endif %}"
                        data-type="{% if case.incident_type %}{{ case.incident_type.name }}{% else %}Not specified{% endif %}"
                        data-grade="{{ case.grade_level }}"
                        data-student="{% if case.reported_student %}{{ case.reported_student.get_full_name|lower }} {{ case.reported_student.username|lower }}{% else %}{{ case.involved_students|lower }}{% endif %}">
                        <td class="px-3 py-2">
                            <div class="text-sm font-medium text-gray-900">{{ case.case_id }}</div>
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-sm font-medium text-gray-900">
                                {% if case.reported_student %}
                                {{ case.reported_student.get_full_name }}
                                {% else %}
                                {{ case.involved_students|default:"Not specified" }}
                                {% endif %}
                                {% if case.reported_student and case.reported_student.id in repeat_offender_ids %}
                                <span
                                    class="ml-1 px-2 py-0.5 text-xs font-bold rounded bg-red-100 text-red-800">REPEAT</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-3 py-2">
                            {% if case.incident_type %}
                            <div class="text-sm text-gray-900">{{ case.incident_type.name }}</div>
                            {% else %}
                            <div class="text-sm text-gray-400">Not specified</div>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2">
                            {% if case.incident_type %}
                            {% if case.incident_type.severity == 'prohibited' %}
                            <span class="text-xs px-1.5 py-0.5 bg-red-100 text-red-800 rounded font-semibold">PA</span>
                            {% elif case.incident_type.severity == 'school_policy' %}
                            <span
                                class="text-xs px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded font-semibold">OSP</span>
                            {% endif %}
                            {% else %}
                            <span class="text-xs text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-sm text-gray-900">G{{ case.grade_level }} - {{ case.section_name }}</div>
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-sm text-gray-900">{{ case.incident_date|date:"M d, Y" }}</div>
                        </td>
                        <td class="px-3 py-2">
                            <a href="{% url 'major_case_detail' case.id %}"
                                class="inline-flex items-center justify-center px-3 py-1.5 text-xs font-medium text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors">
                                <i class="fas fa-eye mr-1"></i>View
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="text-gray-500">No reports to display</div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    let searchTimeout;

    function performSearch() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function () {
            const searchValue = document.getElementById('searchInput').value;
            if (searchValue.length >= 2 || searchValue.length === 0) {
                window.location.href = '?search=' + encodeURIComponent(searchValue);
            }
        }, 500); // Wait 500ms after user stops typing
    }

    function filterCases() {
        const typeFilter = document.getElementById('filter-type').value;
        const gradeFilter = document.getElementById('filter-grade').value;
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.querySelectorAll('.case-row');

        rows.forEach(row => {
            const type = row.getAttribute('data-type');
            const grade = row.getAttribute('data-grade');
            const student = row.getAttribute('data-student');

            const typeMatch = !typeFilter || type === typeFilter;
            const gradeMatch = !gradeFilter || grade === gradeFilter;
            const searchMatch = !searchValue || student.includes(searchValue);

            if (typeMatch && gradeMatch && searchMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function saveLRN(event, caseId) {
        const lrnInput = document.getElementById('lrn_' + caseId);
        const lrn = lrnInput.value.trim();

        // Validate LRN (12 digits)
        if (!/^\d{12}$/.test(lrn)) {
            alert('Please enter a valid 12-digit LRN');
            event.preventDefault();
            return false;
        }

        // Add the LRN value to the form
        const form = event.target;
        const lrnField = form.querySelector('input[name="lrn"]');
        if (!lrnField) {
            const hiddenLRN = document.createElement('input');
            hiddenLRN.type = 'hidden';
            hiddenLRN.name = 'lrn';
            hiddenLRN.value = lrn;
            form.appendChild(hiddenLRN);
        } else {
            lrnField.value = lrn;
        }

        return true; // Allow form submission
    }

    // Apply filters when page loads if search query exists
    document.addEventListener('DOMContentLoaded', function () {
        if (document.getElementById('searchInput').value) {
            filterCases();
        }
    });
</script>
{% endblock %}